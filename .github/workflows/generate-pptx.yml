name: Generate PowerPoint Presentations

# This workflow generates PowerPoint presentations from Marp markdown slides
# and creates a pull request for review.
#
# Auto-approval: The bot cannot approve its own PR with GITHUB_TOKEN.
# To enable full automation, create a Personal Access Token with repo permissions
# and add it as a secret named 'PAT_FOR_PR_APPROVAL'.

on:
  # Manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      commit_files:
        description: 'Commit PPTX files to repository'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# Grant permissions for creating PRs and auto-merge
permissions:
  contents: write
  pull-requests: write

jobs:
  generate-pptx:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Clean and create output directory
        run: |
          # Remove old PPTX files to ensure fresh generation
          rm -rf presentations/pptx
          mkdir -p presentations/pptx

      - name: Convert presentations to PPTX
        run: |
          echo "Converting Marp markdown to PowerPoint..."

          for file in presentations/slides-*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              echo "Converting: $file -> presentations/pptx/${filename}.pptx"
              marp "$file" --pptx -o "presentations/pptx/${filename}.pptx"
            fi
          done

          echo "Conversion complete!"
          ls -la presentations/pptx/

      - name: Upload PPTX as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: powerpoint-presentations
          path: presentations/pptx/*.pptx
          retention-days: 30

      - name: Create Pull Request
        if: ${{ inputs.commit_files == 'true' }}
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Update generated PowerPoint presentations"
          title: "Update PowerPoint presentations from Marp slides"
          body: |
            ## Auto-generated PowerPoint presentations

            This PR contains updated PPTX files generated from Marp markdown slides.

            **Files updated:**
            - All `.pptx` files in `presentations/pptx/`

            **Generated by:** GitHub Actions workflow
            **Triggered by:** @${{ github.actor }}

            ‚úÖ Safe to merge - these are generated files from source markdown
          branch: update-pptx-presentations
          delete-branch: true
          labels: |
            documentation
            automated

      - name: Enable auto-merge on PR (if repository allows)
        if: ${{ inputs.commit_files == 'true' && steps.create-pr.outputs.pull-request-number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Attempting to enable auto-merge for PR #${{ steps.create-pr.outputs.pull-request-number }}"
          if gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} --auto --squash --repo ${{ github.repository }} 2>/dev/null; then
            echo "‚úÖ Auto-merge enabled"
          else
            echo "‚ö†Ô∏è  Auto-merge not available for this repository"
            echo "To enable: Settings ‚Üí General ‚Üí Allow auto-merge"
            echo "PR will need manual merge after approval"
          fi

      - name: Auto-approve PR (if PAT available)
        if: ${{ inputs.commit_files == 'true' && steps.create-pr.outputs.pull-request-number }}
        env:
          GH_TOKEN: ${{ secrets.PAT_FOR_PR_APPROVAL || secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ secrets.PAT_FOR_PR_APPROVAL }}" ]; then
            echo "Approving PR #${{ steps.create-pr.outputs.pull-request-number }} with PAT"
            gh pr review ${{ steps.create-pr.outputs.pull-request-number }} --approve --repo ${{ github.repository }}
            echo "‚úÖ PR approved and will auto-merge"
          else
            echo "‚ö†Ô∏è  No PAT_FOR_PR_APPROVAL secret found - skipping auto-approval"
            echo "Manual approval required for PR to merge"
          fi

      - name: PR Summary
        if: ${{ inputs.commit_files == 'true' && steps.create-pr.outputs.pull-request-number }}
        run: |
          echo "‚úÖ Pull request created: #${{ steps.create-pr.outputs.pull-request-number }}"
          echo "üîó URL: ${{ steps.create-pr.outputs.pull-request-url }}"
          echo ""
          if [ -n "${{ secrets.PAT_FOR_PR_APPROVAL }}" ]; then
            echo "‚úÖ PR approved with PAT"
            echo "üìã Next step: Manually merge the PR"
          else
            echo "üìã Next steps:"
            echo "  1. Approve the PR:"
            echo "     gh pr review ${{ steps.create-pr.outputs.pull-request-number }} --approve"
            echo "     or via GitHub UI: ${{ steps.create-pr.outputs.pull-request-url }}"
            echo ""
            echo "  2. Merge the PR:"
            echo "     gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} --squash"
            echo "     or use the Merge button in GitHub UI"
          fi
          echo ""
          echo "üí° To enable repository auto-merge (optional):"
          echo "   Settings ‚Üí General ‚Üí Pull Requests ‚Üí Allow auto-merge"
